name: Deploy to Cloudflare

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Deploy backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd apps/backend
          npx wrangler d1 execute todo-db --remote --file=./migrations/0001_create_users_table.sql
          npx wrangler d1 execute todo-db --remote --file=./migrations/0002_create_todos_table.sql
          echo "${{ secrets.FIREBASE_PROJECT_ID }}" | npx wrangler secret put FIREBASE_PROJECT_ID
          BACKEND_DEPLOY_OUTPUT=$(npx wrangler deploy)
          BACKEND_URL=$(echo "$BACKEND_DEPLOY_OUTPUT" | grep -o 'https://[^[:space:]]*workers\.dev')
          echo "BACKEND_URL=$BACKEND_URL" >> $GITHUB_ENV

      - name: Deploy frontend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "$BACKEND_URL" | npx wrangler pages secret put VITE_API_URL --project-name fullstack-frontend
          echo "${{ secrets.VITE_FIREBASE_API_KEY }}" | npx wrangler pages secret put VITE_FIREBASE_API_KEY --project-name fullstack-frontend
          echo "${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}" | npx wrangler pages secret put VITE_FIREBASE_AUTH_DOMAIN --project-name fullstack-frontend
          echo "${{ secrets.VITE_FIREBASE_PROJECT_ID }}" | npx wrangler pages secret put VITE_FIREBASE_PROJECT_ID --project-name fullstack-frontend
          echo "${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}" | npx wrangler pages secret put VITE_FIREBASE_STORAGE_BUCKET --project-name fullstack-frontend
          echo "${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}" | npx wrangler pages secret put VITE_FIREBASE_MESSAGING_SENDER_ID --project-name fullstack-frontend
          echo "${{ secrets.VITE_FIREBASE_APP_ID }}" | npx wrangler pages secret put VITE_FIREBASE_APP_ID --project-name fullstack-frontend
          echo "${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}" | npx wrangler pages secret put VITE_FIREBASE_MEASUREMENT_ID --project-name fullstack-frontend
          npx wrangler pages deploy apps/frontend/dist --project-name fullstack-frontend