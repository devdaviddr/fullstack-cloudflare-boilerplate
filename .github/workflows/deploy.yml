name: Deploy to Cloudflare

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate semantic version
        run: |
          BASE_VERSION=$(cat VERSION)
          echo "BUILD_VERSION=${BASE_VERSION}+${{ github.run_number }}.$(git rev-parse --short HEAD).$(date +%Y%m%d%H%M)" >> $GITHUB_ENV

      - name: Set Pages secrets (build-time)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "${{ secrets.VITE_FIREBASE_API_KEY }}" | npx wrangler pages secret put VITE_FIREBASE_API_KEY --project-name fullstack-frontend || true
          echo "${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}" | npx wrangler pages secret put VITE_FIREBASE_AUTH_DOMAIN --project-name fullstack-frontend || true
          echo "${{ secrets.VITE_FIREBASE_PROJECT_ID }}" | npx wrangler pages secret put VITE_FIREBASE_PROJECT_ID --project-name fullstack-frontend || true
          echo "${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}" | npx wrangler pages secret put VITE_FIREBASE_STORAGE_BUCKET --project-name fullstack-frontend || true
          echo "${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}" | npx wrangler pages secret put VITE_FIREBASE_MESSAGING_SENDER_ID --project-name fullstack-frontend || true
          echo "${{ secrets.VITE_FIREBASE_APP_ID }}" | npx wrangler pages secret put VITE_FIREBASE_APP_ID --project-name fullstack-frontend || true
          echo "${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}" | npx wrangler pages secret put VITE_FIREBASE_MEASUREMENT_ID --project-name fullstack-frontend || true

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        env:
          VITE_BUILD_VERSION: ${{ env.BUILD_VERSION }}
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}
        run: pnpm run build

      - name: Run D1 migrations
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd apps/backend
          npx wrangler d1 execute todo-db --remote --file=./migrations/0001_create_users_table.sql
          npx wrangler d1 execute todo-db --remote --file=./migrations/0002_create_todos_table.sql

      - name: Set Worker secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd apps/backend
          echo "${{ secrets.FIREBASE_PROJECT_ID }}" | npx wrangler secret put FIREBASE_PROJECT_ID --env="" || true
          echo "$BUILD_VERSION" | npx wrangler secret put BUILD_VERSION --env="" || true

      - name: Deploy backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd apps/backend
          BACKEND_DEPLOY_OUTPUT=$(npx wrangler deploy --env="")
          BACKEND_URL=$(echo "$BACKEND_DEPLOY_OUTPUT" | grep -o 'https://[^[:space:]]*workers\.dev')
          echo "BACKEND_URL=$BACKEND_URL" >> $GITHUB_ENV
          echo "Backend deployed to: $BACKEND_URL"

      - name: Set Pages secrets (runtime)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "$BACKEND_URL" | npx wrangler pages secret put VITE_API_URL --project-name fullstack-frontend || true
          echo "$BUILD_VERSION" | npx wrangler pages secret put VITE_BUILD_VERSION --project-name fullstack-frontend || true

      - name: Deploy frontend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          FRONTEND_DEPLOY_OUTPUT=$(npx wrangler pages deploy apps/frontend/dist --project-name fullstack-frontend --commit-dirty=true --commit-message="${{ github.event.head_commit.message }}")
          FRONTEND_URL=$(echo "$FRONTEND_DEPLOY_OUTPUT" | grep -o 'https://[^[:space:]]*\.pages\.dev' | head -1)
          echo "Frontend deployed to: $FRONTEND_URL"
          echo "Production URL: https://fullstack-frontend.pages.dev"